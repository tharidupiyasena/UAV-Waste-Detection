<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>UAV Waste Detection</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
nav{background:#1e293b;border-bottom:1px solid #334155;padding:0 24px;display:flex;align-items:center;height:56px;gap:24px}
nav .logo{font-size:1.1rem;font-weight:700;color:#38bdf8;text-decoration:none}
nav a{color:#94a3b8;text-decoration:none;font-size:.9rem;padding:6px 12px;border-radius:6px;transition:.15s}
nav a:hover,nav a.active{background:#334155;color:#e2e8f0}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.page{max-width:980px;margin:36px auto;padding:0 20px}
h1{font-size:1.8rem;font-weight:700;color:#f1f5f9;margin-bottom:6px}
.sub{color:#64748b;font-size:.95rem;margin-bottom:28px}

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card{background:#1e293b;border:1px solid #334155;border-radius:14px;padding:28px;margin-bottom:20px}
.card-title{font-size:1rem;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:.05em;margin-bottom:16px}

/* ‚îÄ‚îÄ UPLOAD ZONE ‚îÄ‚îÄ */
.drop-zone{border:2px dashed #334155;border-radius:10px;padding:48px 24px;text-align:center;cursor:pointer;transition:.2s;background:#0f172a}
.drop-zone:hover,.drop-zone.drag{border-color:#38bdf8;background:#0c1929}
.drop-zone input{display:none}
.drop-zone .icon{font-size:2.5rem;margin-bottom:12px}
.drop-zone label{cursor:pointer;color:#38bdf8;font-weight:600;font-size:1rem}
.drop-zone p{color:#475569;font-size:.85rem;margin-top:6px}

#preview-box{margin-top:16px;text-align:center;display:none}
#preview-box img{max-width:100%;max-height:320px;border-radius:10px;border:1px solid #334155}
#preview-box .fname{margin-top:8px;color:#64748b;font-size:.85rem}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;gap:8px;padding:11px 22px;border:none;border-radius:8px;font-size:.95rem;font-weight:600;cursor:pointer;transition:.15s;text-decoration:none}
.btn-primary{background:#0ea5e9;color:#fff}.btn-primary:hover{background:#0284c7}
.btn-primary:disabled{background:#334155;color:#64748b;cursor:not-allowed}
.btn-green{background:#10b981;color:#fff}.btn-green:hover{background:#059669}
.btn-amber{background:#f59e0b;color:#fff}.btn-amber:hover{background:#d97706}
.btn-block{width:100%;justify-content:center;margin-top:14px}

/* ‚îÄ‚îÄ LOADER ‚îÄ‚îÄ */
#loader{display:none;text-align:center;padding:28px}
.spinner{border:4px solid #334155;border-top:4px solid #38bdf8;border-radius:50%;width:44px;height:44px;animation:spin .8s linear infinite;margin:0 auto 14px}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ */
#results{display:none}
.stats-row{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px}
.badge{padding:8px 18px;border-radius:20px;font-size:.9rem;font-weight:600}
.badge-blue{background:#0c2a4a;border:1px solid #0ea5e9;color:#38bdf8}
.badge-green{background:#052e16;border:1px solid #10b981;color:#34d399}
.badge-red{background:#2d0a0a;border:1px solid #ef4444;color:#f87171}

.img-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.img-grid img{width:100%;border-radius:8px;border:1px solid #334155}
.img-label{text-align:center;font-size:.8rem;color:#64748b;margin-top:6px}

.json-box{background:#020617;color:#86efac;border-radius:8px;padding:16px;font-family:monospace;font-size:.8rem;overflow:auto;max-height:360px;white-space:pre;border:1px solid #1e3a2f}

.action-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:16px}

/* ‚îÄ‚îÄ LS MODAL ‚îÄ‚îÄ */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center}
.modal-bg.show{display:flex}
.modal{background:#1e293b;border:1px solid #334155;border-radius:14px;padding:32px;max-width:480px;width:90%;text-align:center}
.modal h2{font-size:1.3rem;color:#f1f5f9;margin-bottom:12px}
.modal p{color:#94a3b8;font-size:.9rem;margin-bottom:24px;line-height:1.6}
.modal .btns{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}

/* ‚îÄ‚îÄ ERROR ‚îÄ‚îÄ */
.error-box{background:#2d0a0a;border:1px solid #ef4444;color:#f87171;border-radius:8px;padding:14px;margin-top:12px}

@media(max-width:600px){.img-grid{grid-template-columns:1fr}.action-row{flex-direction:column}}
</style>
</head>
<body>

<nav>
  <a class="logo" href="/">üõ∏ UAV Detect</a>
  <a href="/" class="active">Detect</a>
  <a href="/dashboard">Dashboard</a>
</nav>

<div class="page">
  <h1>UAV Waste Detection</h1>
  <p class="sub">SAHI + YOLOv8 ¬∑ Slice-Based ¬∑ Drone Imagery</p>

  <!-- Upload -->
  <div class="card">
    <div class="card-title">Upload Drone Image</div>
    <div class="drop-zone" id="drop-zone">
      <input type="file" id="img-input" accept="image/jpeg,image/png,image/webp"/>
      <div class="icon">üì°</div>
      <label for="img-input">Click to select image</label>
      <p>JPG ¬∑ PNG ¬∑ WEBP ¬∑ Large drone images supported</p>
    </div>
    <div id="preview-box">
      <img id="preview-img" src="" alt="preview"/>
      <div class="fname" id="fname"></div>
    </div>
    <button class="btn btn-primary btn-block" id="detect-btn" disabled onclick="runDetection()">
      üîç Run SAHI Detection
    </button>
  </div>

  <!-- Loader -->
  <div class="card" id="loader">
    <div class="spinner"></div>
    <p style="color:#64748b">Running sliced inference... large images may take 10‚Äì30 s</p>
  </div>

  <!-- Results -->
  <div class="card" id="results">
    <div class="card-title">Detection Results</div>
    <div class="stats-row" id="stats-row"></div>
    <div class="img-grid" id="img-grid"></div>
    <div class="action-row" id="action-row"></div>
    <div class="card-title" style="margin-top:20px">Detection JSON</div>
    <div class="json-box" id="json-box"></div>
  </div>

  <div id="err-container"></div>
</div>

<!-- Label Studio Modal -->
<div class="modal-bg" id="ls-modal">
  <div class="modal">
    <h2>üè∑Ô∏è Open Label Studio</h2>
    <p id="ls-msg">The image has been copied to <code>annotation_images/</code>.<br>
    Label Studio will open in a new tab at <strong>localhost:8080</strong>.<br><br>
    After annotating, click <em>"Mark as Annotated"</em> to update the dashboard.</p>
    <div class="btns">
      <button class="btn btn-primary" id="open-ls-btn" onclick="openLS()">Open Label Studio</button>
      <button class="btn btn-green" id="mark-ann-btn" onclick="markAnnotated()">‚úÖ Mark as Annotated</button>
      <button class="btn" style="background:#334155;color:#94a3b8" onclick="closeModal()">Close</button>
    </div>
  </div>
</div>

<script>
let currentId   = null;
let lsUrl       = null;
const input     = document.getElementById('img-input');
const preview   = document.getElementById('preview-img');
const previewBox= document.getElementById('preview-box');
const detectBtn = document.getElementById('detect-btn');

// ‚îÄ‚îÄ drag-drop ‚îÄ‚îÄ
const dz = document.getElementById('drop-zone');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag')});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
dz.addEventListener('drop',e=>{
  e.preventDefault(); dz.classList.remove('drag');
  const f=e.dataTransfer.files[0];
  if(f){input.files=e.dataTransfer.files; handleFile(f);}
});
input.addEventListener('change',()=>{ if(input.files[0]) handleFile(input.files[0]); });

function handleFile(f){
  preview.src=URL.createObjectURL(f);
  previewBox.style.display='block';
  document.getElementById('fname').textContent=`${f.name}  (${(f.size/1024/1024).toFixed(1)} MB)`;
  detectBtn.disabled=false;
  document.getElementById('results').style.display='none';
  document.getElementById('err-container').innerHTML='';
}

async function runDetection(){
  const file=input.files[0];
  if(!file) return;
  detectBtn.disabled=true;
  document.getElementById('loader').style.display='block';
  document.getElementById('results').style.display='none';
  document.getElementById('err-container').innerHTML='';

  const fd=new FormData();
  fd.append('image',file);
  try{
    const res=await fetch('/detect',{method:'POST',body:fd});
    const data=await res.json();
    document.getElementById('loader').style.display='none';
    if(!data.success){ showErr(data.error||'Detection failed'); detectBtn.disabled=false; return; }
    renderResults(data);
    detectBtn.disabled=false;
  }catch(e){
    document.getElementById('loader').style.display='none';
    showErr('Request failed: '+e.message);
    detectBtn.disabled=false;
  }
}

function renderResults(d){
  currentId=d.id;
  // stats
  const n=d.total_detections;
  const stats=document.getElementById('stats-row');
  stats.innerHTML=`<span class="badge badge-blue">üóëÔ∏è Detections: ${n}</span>`
    +(n>0?`<span class="badge badge-red">‚ö†Ô∏è Waste Found</span>`
         :`<span class="badge badge-green">‚úÖ No Waste Detected</span>`);

  // images
  const grid=document.getElementById('img-grid');
  grid.innerHTML='';
  if(d.original_image_url)
    grid.innerHTML+=`<div><img src="${d.original_image_url}"/><div class="img-label">Original</div></div>`;
  if(d.annotated_image_url)
    grid.innerHTML+=`<div><img src="${d.annotated_image_url}"/><div class="img-label">Annotated (SAHI)</div></div>`;

  // action buttons
  const ar=document.getElementById('action-row');
  ar.innerHTML=`
    <button class="btn btn-amber" onclick="openAnnotateModal()">üè∑Ô∏è Annotate in Label Studio</button>`;

  // json
  document.getElementById('json-box').textContent=JSON.stringify(d,null,2);
  document.getElementById('results').style.display='block';
}

async function openAnnotateModal(){
  if(!currentId) return;
  const res=await fetch(`/annotate/${currentId}`,{method:'POST'});
  const d=await res.json();
  if(d.success){
    lsUrl=d.label_studio_url;
    document.getElementById('ls-modal').classList.add('show');
  } else {
    showErr(d.error);
  }
}
function openLS(){ if(lsUrl) window.open(lsUrl,'_blank'); }
async function markAnnotated(){
  if(!currentId) return;
  await fetch(`/api/mark_annotated/${currentId}`,{method:'POST'});
  closeModal();
  alert('‚úÖ Marked as annotated! Check the Dashboard.');
}
function closeModal(){ document.getElementById('ls-modal').classList.remove('show'); }
function showErr(msg){ document.getElementById('err-container').innerHTML=`<div class="error-box">‚ö†Ô∏è ${msg}</div>`; }
</script>
</body>
</html>
